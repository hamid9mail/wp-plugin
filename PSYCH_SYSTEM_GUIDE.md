# راهنمای کامل سیستم جامع روان گستر (Psych Complete System)

## مقدمه
این راهنما به شما کمک می‌کند تا از تمام قابلیت‌ها و شورت‌کدهای موجود در سیستم جامع روان گستر، به خصوص ماژول قدرتمند مسیر رشد (Path Engine)، به بهترین شکل استفاده کنید. این سیستم برای ایجاد تجربه‌های یادگیری پویا، تعاملی و شخصی‌سازی شده طراحی شده است.

---

## بخش ۱: ماژول مسیر رشد (Path Engine)

### ۱.۱ - مفهوم کلیدی: سیستم چند بازیگری (Multi-Actor System)
یکی از قدرتمندترین ویژگی‌های سیستم مسیر رشد، توانایی آن در مدیریت "بازیگران" (Actors) مختلف است. این یعنی سیستم به خوبی درک می‌کند که **چه کسی** در حال انجام یک عمل است و آن عمل **برای چه کسی** ثبت می‌شود.

**این قابلیت چه کاربردی دارد؟**
سناریوی رایج، تعامل **مربی** و **دانشجو** است. یک مربی ممکن است وارد پروفایل دانشجو شود و یک فرم ارزیابی را برای او پر کند. در این حالت:
*   **بازیگر (Actor):** مربی است.
*   **هدف (Target):** دانشجو است.

سیستم به صورت هوشمند و خودکار این تفکیک را انجام می‌دهد. زمانی که یک فرم گرویتی (Gravity Form) در یک ایستگاه قرار می‌گیرد، سیستم فیلدهای مخفی لازم را به آن اضافه می‌کند تا همیشه مشخص باشد که فرم برای کدام دانشجو در حال پر شدن است، حتی اگر مربی آن را ارسال کند.

**نتیجه:** تمام امتیازات، پاداش‌ها و تکمیل ماموریت‌ها به درستی به حساب **دانشجو** واریز می‌شود، نه مربی. این ویژگی زیربنای اصلی تعاملات مربی-محور در سیستم است و به شما اجازه می‌دهد سناریوهای ارزیابی، تایید و بازخورد بسیار پیشرفته‌ای را پیاده‌سازی کنید.

---
این ماژول به شما اجازه می‌دهد تا مسیرهای یادگیری پیچیده، شرطی و تعاملی برای کاربران خود بسازید.

### ۱.۲ - شورت‌کد اصلی مسیر: `[psychocourse_path]`
این شورت‌کد به عنوان کانتینر اصلی برای یک مسیر عمل می‌کند. تمام ایستگاه‌ها باید درون آن قرار گیرند.

**ویژگی‌ها:**
*   `display_mode` (نوع: `string`, پیش‌فرض: `timeline`): نحوه نمایش مسیر را تعیین می‌کند. مقادیر مجاز: `timeline`, `accordion`, `cards`, `treasure_map`, `simple_list`.
*   `theme` (نوع: `string`, پیش‌فرض: `default`): تم رنگی مسیر. مقادیر مجاز: `default`, `dark`, `minimal`, `colorful`.
*   `show_progress` (نوع: `boolean`, پیش‌فرض: `true`): نمایش یا عدم نمایش نوار پیشرفت.
*   `path_title` (نوع: `string`, پیش‌فرض: `''`): عنوان کلی برای مسیر.

---

### ۱.۳ - شورت‌کد ایستگاه: `[station]`
قلب تپنده مسیر شما. هر `[station]` یک مرحله یا ماموریت در مسیر است. ویژگی‌های اصلی آن در جدول زیر آمده است. توضیحات کامل و پیشرفته در بخش‌های بعدی ارائه خواهد شد.

| ویژگی | توضیح |
| :--- | :--- |
| `title` | **(الزامی)** عنوان ایستگاه. |
| `mission_type` | نوع ماموریت (`button_click`, `gform`, `flag`, `purchase`, ...). |
| `mission_target` | هدف ماموریت (بسته به نوع ماموریت، مثلا `form_id:7`). |
| `rewards` | پاداش‌ها پس از تکمیل (`add_points:50|award_badge:3`). |
| `unlock_trigger` | نحوه باز شدن (`sequential` یا `independent`). |
| `icon` | آیکون ایستگاه از کتابخانه Font Awesome. |

---

### ۱.۴ - شورت‌کدهای محتوای ایستگاه
*   `[static_content]...[/static_content]`: محتوای ثابت که همیشه نمایش داده می‌شود.
*   `[mission_content]...[/mission_content]`: محتوای ماموریت که قبل از تکمیل نمایش داده می‌شود.
*   `[result_content]...[/result_content]`: محتوای نتیجه که بعد از تکمیل نمایش داده می‌شود.

---

### ۱.۵ - شورت‌کدهای شرطی و دینامیک
*   `[student_only]...[/student_only]`: محتوا فقط برای دانشجو قابل مشاهده است.
*   `[coach_only]...[/coach_only]`: محتوا فقط برای مربی (در حالت impersonate) قابل مشاهده است.
*   `[mission_submission_count]`: شمارنده پاسخ‌های فرم را در ماموریت‌های `gform` نمایش می‌دهد.

---

### ۱.۶ - سیستم بازیگران پیشرفته (Advanced Actor System)
این سیستم به شما اجازه می‌دهد دقیقاً مشخص کنید چه کسانی می‌توانند یک ماموریت را تکمیل کنند و چه تعداد از آن‌ها برای تکمیل نهایی لازم است.

**ویژگی‌های جدید در `[station]`:**
*   `actors` (نوع: `string`, پیش‌فرض: `self`): تعیین می‌کند چه کسانی مجاز به تکمیل ماموریت هستند. مقادیر با کاما (`,`) جدا می‌شوند.
    *   `self`: خود دانشجو (حالت پیش‌فرض).
    *   `coach`: مربی دانشجو.
    *   `guest_link`: کاربران مهمان (بدون نیاز به لاگین) از طریق یک لینک اشتراک‌گذاری.
    *   `user_link`: هر کاربر دیگری که در سایت لاگین کرده باشد، از طریق لینک اشتراک‌گذاری.
*   `required_actors_count` (نوع: `integer`, پیش‌فرض: `1`): تعداد بازیگران خارجی (`guest_link` یا `user_link`) که باید ماموریت را تکمیل کنند تا ماموریت برای کاربر اصلی تکمیل شود.

**شورت‌کدهای جدید:**
*   `[mission_actor_link]`: یک لینک منحصر به فرد و امن برای اشتراک‌گذاری ماموریت ایجاد می‌کند. این شورت‌کد باید درون ایستگاهی قرار گیرد که `actors` آن شامل `guest_link` یا `user_link` باشد.
*   `[mission_actors_count]`: تعداد بازیگران خارجی که ماموریت را تکمیل کرده‌اند نمایش می‌دهد. (مثال: "۳ از ۵ نفر پاسخ داده‌اند").

**مثال: ماموریت جمع‌آوری بازخورد از ۵ همکار**
```html
[station title="جمع‌آوری بازخورد ۳۶۰ درجه" actors="guest_link" required_actors_count="5" rewards="add_points:200"]
  [static_content]
    <p>برای این مرحله، باید لینک زیر را برای ۵ نفر از همکاران خود ارسال کنید تا فرم بازخورد را برای شما پر کنند.</p>
    <p><strong>لینک شما:</strong> [mission_actor_link]</p>
    <p><strong>وضعیت پیشرفت:</strong> [mission_actors_count]</p>
  [/static_content]
  [result_content]
    <p>تبریک! شما بازخورد لازم را از ۵ نفر دریافت کردید و ۲۰۰ امتیاز کسب نمودید.</p>
  [/result_content]
[/station]
```

---

### ۱.۷ - سیستم تایید مربی (Coach Approval System)
برای ماموریت‌هایی که نیاز به ارزیابی و بازبینی کیفی دارند، می‌توانید تایید نهایی را به مربی واگذار کنید.

**ویژگی جدید در `[station]`:**
*   `requires_approval` (نوع: `string`, پیش‌فرض: `''`): اگر این ویژگی برابر `coach` قرار داده شود، ماموریت پس از انجام توسط دانشجو، وارد حالت "در انتظار تایید" می‌شود.

**گردش کار:**
1.  دانشجو ماموریت را انجام می‌دهد.
2.  وضعیت ایستگاه به "در انتظار تایید" (Pending Approval) تغییر می‌کند.
3.  یک اعلان برای مربی ارسال می‌شود.
4.  مربی در صفحه مسیر دانشجو، یک فرم تایید یا رد مشاهده می‌کند.
5.  تنها پس از تایید مربی، ایستگاه تکمیل شده و پاداش‌ها به دانشجو تعلق می‌گیرد.

**شورت‌کد جدید:**
*   `[mission_approval_form]`: فرم تایید/رد را برای مربی نمایش می‌دهد. این شورت‌کد باید درون تگ‌های `[coach_only]` قرار گیرد تا فقط مربی آن را ببیند.

**مثال: تکلیف نوشتاری با نیاز به تایید مربی**
```html
[station title="ارسال مقاله اول" mission_type="gform" mission_target="form_id:8" requires_approval="coach" rewards="add_points:150"]
  [mission_content]
    <p>مقاله خود را با استفاده از فرم زیر ارسال کنید. مقاله شما پس از ارسال، توسط مربی بررسی خواهد شد.</p>
    [gravityform id="8" ajax="true"]
  [/mission_content]
  [result_content]
    [student_only]
      <p>مقاله شما توسط مربی تایید شد و ۱۵۰ امتیاز دریافت کردید!</p>
    [/student_only]
    [coach_only]
      <p>شما این تکلیف را تایید کرده‌اید.</p>
    [/coach_only]
  [/result_content]
  [static_content]
    [coach_only]
      <div class="approval-box">
        <h4>فرم تایید مربی</h4>
        [mission_approval_form]
      </div>
    [/coach_only]
  [/static_content]
[/station]
```

---

### ۱.۸ - سیستم فلگ (Flag System): یکپارچه‌سازی و کنترل پیشرفته
سیستم فلگ یک مکانیزم قدرتمند برای کنترل پیشرفته مسیر و یکپارچه‌سازی با سایر بخش‌های سایت شماست. فلگ‌ها مانند کلیدهای "خاموش/روشن" در پروفایل هر کاربر عمل می‌کنند که می‌توانند وضعیت‌های مختلفی را در مسیر یادگیری فعال کنند.

**کاربردهای اصلی فلگ:**

1.  **تکمیل یک ماموریت (Mission Completion):** می‌توانید ایستگاهی تعریف کنید که به محض فعال شدن یک فلگ خاص، به طور خودکار تکمیل شود.
2.  **نمایان کردن یک ایستگاه مخفی (Station Visibility):** می‌توانید یک یا چند ایستگاه را به طور کامل مخفی کنید و آن‌ها را تنها زمانی نمایش دهید که یک فلگ خاص برای کاربر فعال شده باشد.

**چگونه یک فلگ را فعال کنیم؟**

دو راه اصلی برای فعال کردن (یا "ست کردن") یک فلگ برای کاربر وجود دارد:

**۱. از طریق پاداش در یک ایستگاه دیگر:**
ساده‌ترین راه برای استفاده از فلگ‌ها، استفاده از پاداش `reveal_station` است.

*   **ویژگی در `[station]`:** `rewards="reveal_station:your_unique_flag_name"`
*   **عملکرد:** وقتی کاربر ایستگاهی با این پاداش را تکمیل می‌کند، فلگ `your_unique_flag_name` برای او فعال می‌شود.

**۲. از طریق کد PHP (برای توسعه‌دهندگان):**
شما می‌توانید از هر جای دیگر در کد سایتتان (مثلاً در یک افزونه دیگر یا فایل `functions.php` قالب) یک فلگ را برای کاربر فعال کنید.

*   **تابع گلوبال:** `psych_complete_mission_by_flag(string $flag_name, int $user_id)`
*   **عملکرد:** این تابع فلگ مشخص شده را برای کاربر مورد نظر فعال می‌کند.

**چگونه از فلگ‌ها در ایستگاه‌ها استفاده کنیم؟**

*   **برای تکمیل خودکار ماموریت:**
    *   `[station mission_type="flag" mission_target="your_flag_name"]`
    *   این ایستگاه به محض فعال شدن فلگ `your_flag_name` تکمیل می‌شود.

*   **برای نمایان کردن ایستگاه مخفی:**
    *   `[station visibility_flag="your_flag_name"]`
    *   این ایستگاه تا زمانی که فلگ `your_flag_name` فعال نشده باشد، به طور کامل از دید کاربر پنهان است.

**مثال ترکیبی: مسیر شرطی بر اساس انتخاب کاربر**

فرض کنید کاربر در یک ایستگاه، یکی از دو مسیر "تکنیکی" یا "مدیریتی" را انتخاب می‌کند.

```html
<!-- ایستگاه انتخاب مسیر -->
[station title="انتخاب مسیر تخصصی"]
  [mission_content]
    <p>کدام مسیر را برای ادامه انتخاب می‌کنید؟</p>
    <!-- این دکمه‌ها می‌توانند با کمی جاوااسکریپت یا از طریق یک فرم، ماموریت را با پاداش متفاوت تکمیل کنند -->
    <button class="complete-mission-btn" data-rewards="reveal_station:path_technical">مسیر تکنیکی</button>
    <button class="complete-mission-btn" data-rewards="reveal_station:path_managerial">مسیر مدیریتی</button>
  [/mission_content]
[/station]

<!-- ایستگاه‌های مربوط به مسیر تکنیکی (در ابتدا مخفی) -->
[station title="درس ۱: مبانی برنامه‌نویسی" visibility_flag="path_technical"]
  ...
[/station]
[station title="درس ۲: الگوریتم‌ها" visibility_flag="path_technical"]
  ...
[/station]

<!-- ایستگاه‌های مربوط به مسیر مدیریتی (در ابتدا مخفی) -->
[station title="درس ۱: اصول مدیریت پروژه" visibility_flag="path_managerial"]
  ...
[/station]
[station title="درس ۲: رهبری تیم" visibility_flag="path_managerial"]
  ...
[/station]
```
*توضیح:* در این مثال، با کلیک روی هر دکمه، یک فلگ متفاوت (`path_technical` یا `path_managerial`) فعال می‌شود. این کار باعث می‌شود که فقط ایستگاه‌های مربوط به مسیر انتخابی کاربر، که قبلاً با `visibility_flag` مخفی شده بودند، برای او نمایان شوند و یک مسیر کاملاً شخصی‌سازی شده ایجاد گردد.

---

## بخش ۲: ماژول شخصی‌سازی (Personalization Module)
این ماژول یک شورت‌کد بسیار قدرتمند به نام `[psych_personalize]` اضافه می‌کند که به شما اجازه می‌دهد محتوای خاصی را بر اساس شرایط مختلف مربوط به کاربر نمایش دهید.

### `[psych_personalize]`
**ویژگی:** `condition` (الزامی)

**ساختار شرط:** `منبع:شناسه عملگر مقدار`
*   **منابع:** `profile`, `quiz`, `role`, `points`, `badge`.
*   **عملگرها:** `=`, `!=`, `>`, `<`, `>=`, `<=`.

**مثال:** نمایش محتوا فقط به کاربرانی با امتیاز بالای ۱۰۰۰.
```html
[psych_personalize condition="points>=1000"]
  <p>شما کاربر ویژه ما هستید!</p>
[/psych_personalize]
```

---

## بخش ۳: شورت‌کدهای عمومی و گیمیفیکیشن
این شورت‌کدها می‌توانند در هر جای سایت برای نمایش اطلاعات کاربر استفاده شوند.

| شورت‌کد | هدف | مثال استفاده |
| :--- | :--- | :--- |
| `[psych_dashboard]` | نمایش داشبورد کامل کاربر. | `[psych_dashboard]` |
| `[psych_report_card]` | نمایش کارنامه عملکردی کاربر. | `[psych_report_card user_id="15"]` |
| `[psych_leaderboard]` | نمایش جدول رده‌بندی کاربران. | `[psych_leaderboard count="10"]` |
| `[psych_user_points]` | نمایش امتیازات کاربر. | `شما [psych_user_points] امتیاز دارید.` |
| `[psych_user_level]` | نمایش سطح کاربری. | `سطح شما: [psych_user_level]` |
| `[psych_user_badges]` | نمایش نشان‌های کاربر. | `[psych_user_badges limit="5"]` |

---

## بخش ۴: مثال جامع و کامل (Full Structure Example)
در زیر یک مثال کامل آورده شده است که بسیاری از شورت‌کدها را در عمل نشان می‌دهد.

```html
[psychocourse_path display_mode="timeline" path_title="سفر قهرمانی شما"]

  <!-- ایستگاه اول: شروع ماجرا -->
  [station title="فصل اول: پذیرش دعوت" icon="fas fa-dungeon" rewards="add_points:10"]
    [mission_content]
      <p>برای شروع ماجراجویی کلیک کنید.</p>
    [/mission_content]
  [/station]

  <!-- ایستگاه دوم: تکلیف با تایید مربی -->
  [station title="فصل دوم: ارسال تکلیف" mission_type="gform" mission_target="form_id:8" requires_approval="coach" rewards="add_points:150"]
    [mission_content]
      <p>تکلیف خود را با فرم زیر ارسال کنید تا توسط مربی بررسی شود.</p>
      [gravityform id="8" ajax="true"]
      [coach_only]
        [mission_approval_form]
      [/coach_only]
    [/mission_content]
    [result_content]
      <p>تکلیف شما تایید شد!</p>
    [/result_content]
  [/station]

  <!-- ایستگاه سوم: جمع‌آوری بازخورد از ۳ نفر -->
  [station title="فصل سوم: بازخورد ۳۶۰ درجه" actors="guest_link" required_actors_count="3" rewards="add_points:200"]
    [static_content]
      <p>لینک زیر را برای ۳ نفر ارسال کنید تا برای شما بازخورد ثبت کنند.</p>
      <p><strong>لینک:</strong> [mission_actor_link]</p>
      <p><strong>پیشرفت:</strong> [mission_actors_count]</p>
    [/static_content]
    [result_content]
      <p>شما بازخورد لازم را دریافت کردید.</p>
    [/result_content]
  [/station]

  <!-- ایستگاه چهارم: چالش نهایی (فقط برای کاربران سطح بالا) -->
  [station title="فصل چهارم: غار اژدها" icon="fas fa-dragon" unlock_condition="min_points:500|has_badge:5"]
    [mission_content]
      [psych_personalize condition="points>=500"]
        <p>شما آماده ورود به مرحله نهایی هستید.</p>
      [/psych_personalize]
      [psych_personalize condition="points<500"]
        <p>برای ورود به این مرحله به امتیاز بیشتری نیاز دارید.</p>
      [/psych_personalize]
    [/mission_content]
  [/station]

[/psychocourse_path]
```
